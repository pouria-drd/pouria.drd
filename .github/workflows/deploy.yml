name: ðŸš€ Deploy pouria.drd Website

on:
    push:
        branches:
            - main

jobs:
    deploy:
        name: ðŸ–¥ Deploy to Server
        runs-on: ubuntu-latest

        steps:
            # ðŸ“¥ Step 1: Checkout the Repository
            - name: ðŸ“¥ Checkout Repository
              uses: actions/checkout@v3

            # ðŸ”‘ Step 2: Set Up SSH Connection Securely
            - name: ðŸ”‘ Set Up SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

            # âœ… Step 3: Validate Secrets & Variables (Fixed)
            - name: âœ… Validate Secrets & Variables
              env:
                  EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
                  EMAIL_USE_TLS: ${{ secrets.EMAIL_USE_TLS }}
                  EMAIL_SERVICE: ${{ secrets.EMAIL_SERVICE }}
                  EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
                  EMAIL_HOST_USER: ${{ secrets.EMAIL_HOST_USER }}
                  EMAIL_HOST_PASSWORD: ${{ secrets.EMAIL_HOST_PASSWORD }}
                  DEFAULT_ADMINS_EMAILS: ${{ secrets.DEFAULT_ADMINS_EMAILS }}
              run: |
                  required_vars=("EMAIL_PORT" "EMAIL_USE_TLS" "EMAIL_SERVICE" "EMAIL_HOST" "EMAIL_HOST_USER" "EMAIL_HOST_PASSWORD" "DEFAULT_ADMINS_EMAILS")
                  for var in "${required_vars[@]}"; do
                    if [ -z "${!var}" ]; then
                      echo "âŒ ERROR: Missing required secret: $var"
                      exit 1
                    fi
                  done
                  echo "âœ… All required secrets are set."

            # ðŸ›  Step 4: Create .env File on Server (Fixed)
            - name: ðŸ›  Create .env File
              run: |
                  echo "EMAIL_PORT=${{ secrets.EMAIL_PORT }}" > .env
                  echo "EMAIL_USE_TLS=${{ secrets.EMAIL_USE_TLS }}" >> .env
                  echo "EMAIL_SERVICE=${{ secrets.EMAIL_SERVICE }}" >> .env
                  echo "EMAIL_HOST=${{ secrets.EMAIL_HOST }}" >> .env
                  echo "EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}" >> .env
                  echo "EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}" >> .env
                  echo "DEFAULT_ADMINS_EMAILS=${{ secrets.DEFAULT_ADMINS_EMAILS }}" >> .env

            # ðŸ”„ Step 5: Deploy Code & Restart Server
            - name: ðŸš€ Deploy via SSH
              env:
                  SSH_USER: ${{ secrets.SSH_USER }}
                  SERVER_IP: ${{ secrets.SERVER_IP }}
              run: |
                  ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER_IP << 'EOF'
                    set -e  # Enable error handling
                    echo "ðŸš€ Starting deployment..."

                    # ðŸ“‚ Change to project directory
                    cd ~/frontend/pouria.drd || { echo "âŒ ERROR: Directory not found!"; exit 1; }

                    # ðŸ”„ Pull latest changes
                    git pull origin main || { echo "âŒ ERROR: Git pull failed!"; exit 1; }

                    # ðŸ“¦ Install dependencies (only if package.json changed)
                    if git diff --quiet HEAD^ HEAD -- package.json package-lock.json; then
                      echo "âœ… No changes in dependencies."
                    else
                      echo "ðŸ“¦ Installing dependencies..."
                      npm install || { echo "âŒ ERROR: npm install failed!"; exit 1; }
                    fi

                    # ðŸ”§ Build the project
                    echo "ðŸ›  Building the Next.js app..."
                    npm run build || { echo "âŒ ERROR: Build failed!"; exit 1; }

                    # ðŸš€ Restart with PM2 (ensure PM2 is installed)
                    echo "ðŸ”„ Restarting the app with PM2..."
                    pm2 restart pouria.drd || pm2 start npm --name "pouria.drd" -- start

                    echo "âœ… Deployment successful!"
                  EOF
